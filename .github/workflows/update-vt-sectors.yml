name: Weekly VT Sector & Country Composition Update

on:
    schedule:
        # Runs at 06:00 UTC every Monday.
        - cron: '0 6 * * 1'
    workflow_dispatch: # Allows manual triggering

concurrency:
    group: ${{ github.workflow }}
    cancel-in-progress: true

permissions:
    contents: write

jobs:
    update-vt-data:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: '3.x'

            - name: Install dependencies
              run: pip install -r requirements.txt

            - name: Update VT sector allocation
              run: python scripts/update_vt_sectors.py
              env:
                  SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}

            - name: Update VT country composition
              run: python scripts/fetch_etf_country_allocations.py
              env:
                  SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}

            - name: Update VT market cap breakdown
              run: python scripts/update_vt_marketcap.py
              continue-on-error: true # Fail-open: continue even if this step fails

            - name: Update VT HHI from ETFRC.com
              run: python scripts/update_vt_hhi.py
              env:
                  SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
              continue-on-error: true # Fail-open: keep existing value if fetch fails

            - name: Regenerate geography data with updated allocations
              run: python scripts/generate_geography_data.py

            - name: Regenerate market cap data with updated VT breakdown
              run: python scripts/generate_marketcap_from_composition.py
              continue-on-error: true # Fail-open: continue even if this step fails

            - name: Regenerate composition data
              run: python scripts/generate_composition_data.py
              continue-on-error: true # Fail-open: continue even if this step fails

            - name: Commit and push changes
              uses: stefanzweifel/git-auto-commit-action@v7
              with:
                  commit_message: 'chore(data): VT のセクター配分・国別構成・時価総額・HHI を自動更新 [skip ci]'
                  file_pattern: 'data/fund_sector_allocations.json data/fund_country_allocations.json data/fund_marketcap_breakdown.json data/etf_hhi.json data/output/figures/composition.json data/output/figures/sectors.json data/output/figures/geography.json data/output/figures/geography_summary.txt data/output/figures/geography_aggregated.json data/output/figures/marketcap.json'
