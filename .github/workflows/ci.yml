name: CI

on:
    push:
        branches: [main, master, '**/*']
    pull_request:
        branches: ['**/*']

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 'lts/*'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Lint
              run: npm run lint

            - name: Test
              run: npm test

    python:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v5

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.x'
                  cache: 'pip'

            - name: Install Python dev requirements
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements-dev.txt

            - name: Pre-commit (hooks)
              run: make precommit

            - name: Ruff (lint)
              run: ruff check scripts tests

            - name: Black (format check)
              run: black --check .

            - name: Mypy (type check)
              run: mypy

            - name: Bandit (security)
              run: bandit -r scripts -lll

            - name: Markdown lint
              run: |
                npm install -g markdownlint-cli
                markdownlint **/*.md --ignore node_modules

            - name: Pytest
              run: pytest

            - name: Verify bin permissions
              run: make check-perms
