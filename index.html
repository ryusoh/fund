<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund</title>
    <style>
        body {
            background-color: #000000; 
            color: #FFFFFF; /* Set default text color to white for visibility */
            margin: 0; /* Remove default browser margins */
            height: 100vh; /* Ensure the body takes up the full viewport height */
            font-family: Arial, Helvetica, sans-serif; /* Standard font stack */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            padding: 20px; /* Add some padding so table isn't at the very edge */
        }
        /* Ensure table and h2 also use the custom font */
        table, th, td, h2 {
            font-family: Arial, Helvetica, sans-serif; /* Standard font stack */
        }

        /* Use a clearer, standard font for numerical data for better readability */
        td.allocation,
        td.price,
        td.cost,
        td.shares,
        td.value,
        td.pnl,
        #total-portfolio-value {
            font-family: Arial, Helvetica, sans-serif;
            /* You could also adjust font-weight if needed, e.g., font-weight: normal; or font-weight: 500; */
        }
        /* New wrapper for responsive table */
        .table-responsive-container {
            width: 85%; /* Adjust width for desktop */
            max-width: 900px; /* Max width for larger screens */
            margin: 30px auto; /* Center the container and add vertical spacing */
            overflow-x: auto; /* Enable horizontal scroll if content overflows */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS for better UX */
            background-color: #121212; /* Slightly off-black background for the container */
            border-radius: 8px; /* Rounded corners for the container */
            padding: 5px 10px 10px 10px; /* Internal padding (less on top for table header) */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25); /* Softer shadow */
        }
        table {
            width: 100%; /* Table fills the responsive container */
            margin: 0; /* No margin for table itself, container handles it */
            border-spacing: 0; /* Remove spacing between cells */
            /* border-collapse: collapse; */ /* Not strictly needed if using border-spacing: 0 and border-bottom only */
        }
        th, td {
            border: none; /* Remove all default borders */
            padding: 12px 15px; /* More spacious padding */
            font-size: 0.9em; /* Base font size for table cells */
            text-align: left;
            border-bottom: 1px solid #282828; /* Subtle bottom border for row separation */
        }
        th {
            background-color: transparent; /* No specific background for header cells */
            color: #b0b0b0; /* Lighter grey for header text */
            font-weight: 600; /* Semi-bold */
            font-size: 0.8em; /* Adjusted header font size */
            text-transform: uppercase; /* Uppercase for a more formal look */
            letter-spacing: 0.05em; /* Slight letter spacing */
            border-bottom: 1px solid #383838; /* Slightly more prominent border for header */
        }
        /* Column width optimizations */
        table {
            table-layout: auto; /* This is default, but good to be explicit. Browser adjusts to content. */
        }
        th:nth-child(1) { width: 20%; } /* Ticker */
        th:nth-child(2) { width: 15%; } /* Allocation */
        th:nth-child(3) { width: 10%; } /* Price */
        th:nth-child(4) { width: 10%; } /* Cost */
        th:nth-child(5) { width: 10%; } /* Shares */
        th:nth-child(6) { width: 20%; } /* Value */
        th:nth-child(7) { width: 15%; } /* PnL */

        /* Prevent wrapping in data cells for a more compact look */
        td.price, td.cost, td.shares, td.pnl, td.value, td.allocation {
            white-space: nowrap;
        }
        tbody tr:last-child td {
            border-bottom: none; /* Remove border from the last row's cells */
        }
        tbody tr:hover {
            background-color: #1a1a1a; /* Subtle hover effect for data rows */
        }
        /* Styling for the table footer */
        tfoot td {
            border-top: 1px solid #383838; /* Separator line above the footer */
            /* Match header styling for coherence */
            color: #b0b0b0; /* Lighter grey for text, same as th */
            font-weight: 600; /* Semi-bold, same as th */
            font-size: 0.8em; /* Same font size as th */
            text-transform: uppercase; /* Uppercase, same as th */
            letter-spacing: 0.05em; /* Slight letter spacing, same as th */
            text-align: right; /* Align total to the right */
            padding-top: 15px; /* More top padding for footer */
            padding-bottom: 15px; /* More bottom padding for footer */
        }
        #fundPieChartContainer {
            width: 100%; /* Increased width */
            max-width: 700px; /* Increased max-width */
            margin: 10px auto 10px; /* Horizontally center, top margin 0, bottom margin 20px */
        }
        .hidden {
            display: none;
        }
        /* .no-scroll class removed as JS will handle body overflow directly */

        /* Media Query for mobile devices */
        @media (max-width: 768px) {
            html {
                /* Ensure html element also restricts overflow on mobile */
                height: 100vh !important; /* Full viewport height */
                overflow: hidden !important; /* Prevent all scroll on html */
                position: relative; /* Helps iOS honor overflow */
                overscroll-behavior-y: contain !important; /* Prevents scroll chaining/bounce */
                touch-action: none !important; /* Disable touch-based scrolling/panning */
            }
            body {
                position: fixed !important; /* Pin body to viewport */
                top: 0 !important;
                left: 0 !important;
                width: 100% !important; /* Full viewport width */
                height: 100% !important; /* Full viewport height */
                overflow-y: hidden !important; /* Still hide vertical overflow */
                overscroll-behavior-y: contain !important; /* Prevent bounce */
                touch-action: none !important; /* Disable touch actions */
                /* Existing body styles like background, padding, box-sizing will apply to this fixed container */
            }
            .table-responsive-container {
                width: 90%;
                margin: 0 auto; /* Top and bottom margin 0, centered horizontally */
                padding: 0 5px 0 5px; /* Reduce bottom padding, keep top minimal for header */
            }
            th, td {
                padding: 8px 6px; /* Further reduce cell padding */
                font-size: 0.8em; /* Adjusted font size for mobile cells */
            }
            th { 
                font-size: 0.7em; /* Adjusted font size for mobile headers */
                padding-top: 8px; /* Ensure header has some top padding */
                padding-bottom: 8px;
            }
            #fundPieChartContainer { /* mobile styles are fine */
                width: 90%; /* Allow chart to take full width */
                max-width: 90%; /* Max width for mobile */
                margin: 0 auto 5px; /* Horizontally center, top margin 0, reduced bottom margin to 5px */
                touch-action: none; /* Disable touch-based scrolling/panning */
            }
            h2 { /* For the total portfolio value */
                font-size: 1em; /* Reduce font size */
                margin: 5px auto 10px auto; /* Center and adjust vertical margins */
            }
            /* Adjust tfoot for mobile */
            tfoot td {
                padding: 10px 8px;
                font-size: 0.7em;
                text-align: left;
            }
            table {
                width: 100%; /* Table takes full width of its scrollable container */
                min-width: 650px; /* Ensures table content isn't too squished before scrolling starts */
                margin: 0; /* Remove auto margin as container handles layout */
                touch-action: pan-x; /* Allow horizontal pan for table content */
            }
        }
    </style>
</head>
<body>
    <div id="fundPieChartContainer"><canvas id="fundPieChart"></canvas></div>
    <div class="table-responsive-container">
        <table class="hidden">
            <thead>
                <tr>
                    <th scope="col">Holding</th>
                    <th scope="col">Allocation</th>
                    <th scope="col">Price</th>
                    <th scope="col">Cost</th>
                    <th scope="col">Shares</th>
                    <th scope="col">Value</th>
                    <th scope="col">PnL</th>
                </tr>
            </thead>
            <tbody>
                <!-- Example Row: You can add more rows like this -->
                <tr data-ticker="VT">
                    <td>VT</td>
                    <td class="allocation">0.00</td>
                    <td class="price">$0.00</td>
                    <td class="cost">$95.65</td>
                    <td class="shares">2601.642</td> <!-- Original value, will be rounded by JS -->
                    <td class="value">$0.00</td>
                    <td class="pnl">$0.00</td>
                </tr>
                <tr data-ticker="ANET">
                    <td>ANET</td>
                    <td class="allocation">0.00</td>
                    <td class="price">$0.00</td>
                    <td class="cost">$65.18</td>
                    <td class="shares">2392.1984</td> <!-- Original value, will be rounded by JS -->
                    <td class="value">$0.00</td>
                    <td class="pnl">$0.00</td>
                </tr>
                <tr data-ticker="GOOG">
                    <td>GOOG</td>
                    <td class="allocation">0.00</td>
                    <td class="price">$0.00</td>
                    <td class="cost">$172.54</td>
                    <td class="shares">718.218</td> <!-- Original value, will be rounded by JS -->
                    <td class="value">$0.00</td>
                    <td class="pnl">$0.00</td>
                </tr>
                <tr data-ticker="PDD">
                    <td>PDD</td>
                    <td class="allocation">0.00</td>
                    <td class="price">$0.00</td>
                    <td class="cost">$107.17</td>
                    <td class="shares">1000.597</td> <!-- Original value, will be rounded by JS -->
                    <td class="value">$0.00</td>
                    <td class="pnl">$0.00</td>
                </tr>
                <tr data-ticker="BRK-B">
                    <td>BRK-B</td>
                    <td class="allocation">0.00</td>
                    <td class="price">$0.00</td>
                    <td class="cost">$334.96</td>
                    <td class="shares">111</td> <!-- Original value, will be rounded by JS -->
                    <td class="value">$0.00</td>
                    <td class="pnl">$0.00</td>
                </tr>
                <tr data-ticker="OXY">
                    <td>OXY</td>
                    <td class="allocation">0.00</td>
                    <td class="price">$0.00</td>
                    <td class="cost">$49.39</td>
                    <td class="shares">1246.09</td> <!-- Original value, will be rounded by JS -->
                    <td class="value">$0.00</td>
                    <td class="pnl">$0.00</td>
                </tr>
                <tr data-ticker="GEO">
                    <td>GEO</td>
                    <td class="allocation">0.00</td>
                    <td class="price">$0.00</td>
                    <td class="cost">$18.76</td>
                    <td class="shares">540.834</td> <!-- Original value, will be rounded by JS -->
                    <td class="value">$0.00</td>
                    <td class="pnl">$0.00</td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="7" id="table-footer-summary">Total Holdings: <span id="total-portfolio-value-in-table">$0.00</span></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Chart.js Datalabels plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>


    <script>
        // Register ChartDataLabels plugin once globally
        Chart.register(ChartDataLabels);
        // Chart.defaults.color = '#FFFFFF'; // Default color for chart text

        async function fetchAndUpdatePrices() {
            try {
                const response = await fetch('./fund_data.json?t=' + new Date().getTime()); // Add cache buster
                if (!response.ok) {
                    console.error('Failed to fetch fund data:', response.status, response.statusText);
                    return;
                }
                const prices = await response.json();

                let totalPortfolioValue = 0;
                let rowsArray = Array.from(document.querySelectorAll('tbody tr[data-ticker]'));
                const chartData = { labels: [], datasets: [{ data: [], backgroundColor: [] }] };
                const tbody = document.querySelector('table tbody');

                // First pass: calculate individual values and total portfolio value
                rowsArray.forEach(row => {
                    const ticker = row.dataset.ticker;
                    const sharesCell = row.querySelector('td.shares'); 
                    const costCell = row.querySelector('td.cost');
                    const pnlCell = row.querySelector('td.pnl');
                    const shares = parseFloat(sharesCell.textContent);

                    // Round the displayed shares value to 0.01
                    if (sharesCell && !isNaN(shares)) {
                        sharesCell.textContent = shares.toFixed(2);
                    }

                    if (prices[ticker] !== undefined && !isNaN(shares)) {
                        const priceCell = row.querySelector('td.price');
                        const valueCell = row.querySelector('td.value');
                        const currentPrice = parseFloat(prices[ticker]);
                        const cost = parseFloat(costCell.textContent.replace('$', ''));

                        if (priceCell) priceCell.textContent = '$' + currentPrice.toFixed(2);

                        const currentValue = shares * currentPrice;
                        if (valueCell) valueCell.textContent = '$' + currentValue.toFixed(2);
                        
                        // Calculate PnL
                        if (!isNaN(cost) && pnlCell) {
                            const pnlValue = (currentPrice - cost) * shares;
                            const initialCostValue = cost * shares;
                            const pnlPercentage = initialCostValue !== 0 ? (pnlValue / initialCostValue) * 100 : 0;

                            let pnlPrefix = pnlValue >= 0 ? '+' : '';
                            pnlCell.textContent = `${pnlPrefix}${pnlValue.toFixed(2)} (${pnlPrefix}${pnlPercentage.toFixed(2)}%)`;

                            if (pnlValue > 0) {
                                pnlCell.style.color = '#4CAF50'; // Darker Green
                            } else if (pnlValue < 0) {
                                pnlCell.style.color = '#D32F2F'; // Darker Red
                            } else {
                                pnlCell.style.color = ''; // Default color
                            }
                        }
                        totalPortfolioValue += currentValue;
                        row.dataset.currentValue = currentValue; // Store for allocation pass
                    }
                });

                // Update total portfolio value display
                document.getElementById('total-portfolio-value-in-table').textContent = '$' + totalPortfolioValue.toFixed(2);

                // Sort rows by currentValue in descending order
                rowsArray.sort((a, b) => {
                    const valueA = parseFloat(a.dataset.currentValue || "0");
                    const valueB = parseFloat(b.dataset.currentValue || "0");
                    return valueB - valueA; // Sort descending
                });

                // Re-append rows to the table body in sorted order
                tbody.innerHTML = ''; // Clear existing rows
                rowsArray.forEach(row => tbody.appendChild(row));

                // Second pass: calculate and update allocations
                rowsArray.forEach(row => { // Iterate over the sorted array
                    const allocationCell = row.querySelector('td.allocation');
                    if (allocationCell && totalPortfolioValue > 0) {
                        const rowValue = parseFloat(row.dataset.currentValue || "0");
                        const allocationPercentage = (rowValue / totalPortfolioValue) * 100;
                        allocationCell.textContent = allocationPercentage.toFixed(2) + '%';

                        // Prepare data for the chart
                        const ticker = row.dataset.ticker;
                        chartData.labels.push(ticker);
                        chartData.datasets[0].data.push(allocationPercentage);
                        // Add a color for this slice (you can customize these)
                        const baseColor = getBlueColorForSlice(rowsArray.indexOf(row), rowsArray.length);
                        chartData.datasets[0].backgroundColor.push(hexToRgba(baseColor, 0.6)); // Apply 60% opacity
                        }
                });

                // Update or create the pie chart
                updatePieChart(chartData);

                // After initial load and potential DOM changes, check scroll
                checkAndToggleVerticalScroll();

            } catch (error) {
                console.error('Error fetching or processing fund data:', error);
            }
        }

        let fundChartInstance = null;
        function updatePieChart(data) {
            const ctx = document.getElementById('fundPieChart').getContext('2d');
            
            if (fundChartInstance) {
                fundChartInstance.data.labels = data.labels;
                fundChartInstance.data.datasets[0].data = data.datasets[0].data;
                fundChartInstance.data.datasets[0].backgroundColor = data.datasets[0].backgroundColor;
                fundChartInstance.update();
            } else {
                fundChartInstance = new Chart(ctx, {
                    type: 'doughnut', // Use 'pie' for a solid pie chart
                    data: data,
                    options: {
                        responsive: true,
                        layout: {
                            padding: {
                                right: 35,
                                left: 35
                            }
                        },
                        plugins: {
                            // Hide the default legend, as datalabels will replace it
                            legend: {
                                display: false,
                            },
                            datalabels: {
                                display: false, // <--- Set this to false to hide all datalabels
                                formatter: (value, context) => {
                                    // This function now returns an array of objects
                                    // to style the ticker and percentage differently.
                                    const label = context.chart.data.labels[context.dataIndex];
                                    const percentageText = value.toFixed(2) + '%';
                                    const defaultFontSize = context.chart.options.plugins.datalabels.font.size || 10;
                                    const defaultFontColor = context.chart.options.plugins.datalabels.color || '#fff';

                                    return [
                                        {
                                            text: label,
                                            font: {
                                                // family: 'P22UndergroundProThin', // Removed custom font
                                                size: defaultFontSize
                                            },
                                            color: defaultFontColor
                                        },
                                        {
                                            text: percentageText,
                                            font: {
                                                family: 'Arial, Helvetica, sans-serif', // Standard font for numbers
                                                size: defaultFontSize
                                            },
                                            color: defaultFontColor
                                        }
                                    ];
                                },
                                color: '#fff', // Label text color
                                // The font object here acts as a default if not specified in the formatter's array elements
                                font: { size: 10 }, // Default size, family is now set per segment
                                anchor: 'end', // Anchor the label connection at the end of the slice
                                align: 'end', // Align the label text to the end of the connector
                                offset: 8, // Distance from the slice
                                textAlign: 'center', // This will center the block of text (ticker \n percentage)
                                connector: {
                                    display: true,
                                    color: (context) => context.dataset.backgroundColor[context.dataIndex], // Line color same as slice
                                    width: 1
                                }
                            },
                            title: {
                                display: false, // Hide the chart title
                                text: 'Fund Allocation',
                                color: '#FFFFFF', // White title
                                font: {
                                    // family: 'P22UndergroundProThin' // Removed custom font
                                }
                            },
                        },
                        onHover: (event, activeElements, chart) => {
                            const tableElement = document.querySelector('table');
                            const allDataRows = document.querySelectorAll('tbody tr[data-ticker]');
                            // const portfolioSummaryElement = document.getElementById('total-portfolio-value').parentElement; // No longer needed

                            const mouseX = event.x;
                            const mouseY = event.y;
                            let isOverCenter = false;

                            if (chart.getDatasetMeta(0)?.data[0]) { // Optional chaining for safety
                                const firstArc = chart.getDatasetMeta(0).data[0];
                                if (firstArc && typeof firstArc.x === 'number' && typeof firstArc.y === 'number' && typeof firstArc.innerRadius === 'number') {
                                    const centerX = firstArc.x;
                                    const centerY = firstArc.y;
                                    const innerRadius = firstArc.innerRadius;
                                    const distance = Math.sqrt(Math.pow(mouseX - centerX, 2) + Math.pow(mouseY - centerY, 2));
                                    if (distance < innerRadius) {
                                        isOverCenter = true;
                                    }
                                }
                            }

                            let tableShouldBeVisible = false;
                            // let summaryShouldBeVisible = false; // Summary is part of the table now
                            let specificRowToShow = null;

                            if (isOverCenter) {
                                tableShouldBeVisible = true;
                                // summaryShouldBeVisible = true;
                                allDataRows.forEach(row => row.classList.remove('hidden'));
                            } else if (activeElements.length > 0 && chart.data.labels?.length > 0) {
                                const activeSegment = activeElements[0];
                                const dataIndex = activeSegment.index;
                                if (dataIndex >= 0 && dataIndex < chart.data.labels.length) {
                                    const ticker = chart.data.labels[dataIndex];
                                    specificRowToShow = document.querySelector(`tbody tr[data-ticker="${ticker}"]`);
                                    if (specificRowToShow) {
                                        tableShouldBeVisible = true;
                                        // summaryShouldBeVisible = true;
                                        allDataRows.forEach(row => row.classList.toggle('hidden', row !== specificRowToShow));
                                    }
                                }
                            } 
                            
                            // Apply visibility based on determined states
                            if (tableShouldBeVisible) {
                                tableElement.classList.remove('hidden');
                            } else {
                                tableElement.classList.add('hidden');
                                allDataRows.forEach(row => row.classList.add('hidden')); // Ensure all rows are hidden if table is hidden
                            }

                            // Visibility of the summary (now tfoot) is handled by tableElement's visibility
                            checkAndToggleVerticalScroll();
                        }
                    }
                });
            }
        }

        function getBlueColorForSlice(index, totalItems) {
            // A palette of Material Design blues, from darker to lighter.
            // Larger slices (lower index) will get darker blues.
            const cyanPalette = [
                '#006064', // Cyan 900 (Darkest)
                '#00838F', // Cyan 800
                '#0097A7', // Cyan 700
                '#00ACC1', // Cyan 600
                '#00BCD4', // Cyan 500 (Primary Cyan)
                '#26C6DA', // Cyan 400
                '#4DD0E1', // Cyan 300
                '#80DEEA', // Cyan 200
                '#B2EBF2', // Cyan 100
                '#E0F7FA'  // Cyan 50 (Lightest)
            ];
            
            // Cycle through the palette if there are more items than colors
            return cyanPalette[index % cyanPalette.length];
        }

        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            // 3 digits
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) { // 6 digits
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function checkAndToggleVerticalScroll() {
            const isMobile = window.innerWidth <= 768;
            const htmlElement = document.documentElement;
            const bodyElement = document.body;
            
            if (isMobile) { // Only on mobile layout
                htmlElement.style.setProperty('overflow-y', 'hidden', 'important');
                bodyElement.style.setProperty('overflow-y', 'hidden', 'important');
            } else {
                // Ensure scrolling is enabled on desktop
                htmlElement.style.overflowY = '';
                bodyElement.style.overflowY = '';
            }
        }

        // Fetch prices when the page loads
        document.addEventListener('DOMContentLoaded', fetchAndUpdatePrices);
        // Check scroll on window resize
        window.addEventListener('resize', checkAndToggleVerticalScroll);
        // Optional: Refresh prices every 5 minutes (300000 milliseconds)
        // setInterval(fetchAndUpdatePrices, 300000);
    </script>
</body>
</html>